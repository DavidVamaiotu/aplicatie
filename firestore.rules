rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function hasValidPublicUserFieldTypes() {
      return (!('displayName' in request.resource.data) || request.resource.data.displayName is string)
        && (!('email' in request.resource.data) || request.resource.data.email is string)
        && (!('photoURL' in request.resource.data) || request.resource.data.photoURL is string)
        && (!('lastLogin' in request.resource.data) || request.resource.data.lastLogin is string)
        && (!('fcmTokens' in request.resource.data) || request.resource.data.fcmTokens is list);
    }

    // Public inventory read for calendar UI.
    match /rooms/{roomId} {
      allow read: if true;

      match /units/{unitId} {
        allow read: if true;
        allow write: if false;
      }
    }

    // Public profile doc (owner-readable, owner-limited writable fields only).
    match /users/{userId} {
      allow read: if isOwner(userId);

      allow create: if isOwner(userId)
        && request.resource.data.keys().hasOnly(['displayName', 'email', 'photoURL', 'lastLogin', 'fcmTokens'])
        && hasValidPublicUserFieldTypes();

      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(
          ['displayName', 'email', 'photoURL', 'lastLogin', 'fcmTokens']
        )
        && hasValidPublicUserFieldTypes();

      allow delete: if false;

      match /bookings/{bookingId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
    }

    // Server-only canonical records and controls.
    match /orders/{orderId} {
      allow read, write: if false;
    }

    match /users_private/{userId} {
      allow read, write: if false;
    }

    match /booking_rate_limits/{key} {
      allow read, write: if false;
    }

    match /booking_holds/{holdId} {
      allow read, write: if false;
    }

    // Campaigns: client can read active/unexpired; admins write.
    match /campaigns/{campaignId} {
      allow read: if resource.data.isActive == true
                  && resource.data.validUntil > request.time;
      allow write: if request.auth != null
                   && request.auth.token.admin == true;
    }

    // Redemption records are server-only.
    match /discount_usages/{usageId} {
      allow read, write: if false;
    }
  }
}
