rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow public read for rooms and units so the calendar works
    match /rooms/{roomId} {
      allow read: if true;
      
      match /units/{unitId} {
        allow read: if true;
        
        // FINAL STRICT RULE:
        allow update: if 
          // 1. Only 'bookings' field can be changed
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bookings']) &&
          
          // 2. Must add exactly one new booking
          request.resource.data.bookings.size() == resource.data.bookings.size() + 1 &&
          
          // 3. Must NOT delete any existing bookings (New set must contain all Old items)
          request.resource.data.bookings.toSet().hasAll(resource.data.bookings.toSet());
      }
    }
  }
}
