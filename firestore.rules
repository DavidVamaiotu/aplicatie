rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow public read for rooms and units so the calendar works
    match /rooms/{roomId} {
      allow read: if true;
      
      match /units/{unitId} {
        allow read: if true;
        
        // FINAL STRICT RULE:
        allow update: if 
          // 1. Only 'bookings' field can be changed
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bookings']) &&
          
          // 2. Must add exactly one new booking
          request.resource.data.bookings.size() == resource.data.bookings.size() + 1 &&
          
          // 3. Must NOT delete any existing bookings (New set must contain all Old items)
          request.resource.data.bookings.toSet().hasAll(resource.data.bookings.toSet());
      }
    }

    // ─── Users ──────────────────────────────────────────────────────
    // Authenticated users can read/write their own document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Bookings subcollection — user can read/write their own
      match /bookings/{bookingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ─── Campaigns (Promotions) ─────────────────────────────────────
    // Clients can read only active, unexpired campaigns
    // Only admins can create/update/delete
    match /campaigns/{campaignId} {
      allow read: if resource.data.isActive == true 
                  && resource.data.validUntil > request.time;
      allow write: if request.auth != null 
                   && request.auth.token.admin == true;
    }

    // ─── Discount Usages ────────────────────────────────────────────
    // Clients CANNOT read or write. Only Cloud Functions can mutate.
    match /discount_usages/{usageId} {
      allow read, write: if false;
    }
  }
}
